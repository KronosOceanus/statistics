[TOC]

# 马尔科夫链与蒙特卡罗采样

## 马尔科夫链

### 马尔科夫过程

- 模型：$X_n$ 能取到的集合为状态空间 （样本数 / $k$ 个样本），下标 $n$ 表示时间变化 $1,2,3,...,n$（维数）

#### 离散马尔科夫链

- 随机序列 $P(X_{n+1}=j|X_n=i, X_{n-1}=i_{n-1,...,}X_0=i_0)=P(X_{n+1}=j|X_n=i)$（其中 $P(X_{n+1}=j|X_n=i)$ 称为状态转移矩阵），即当前状态只与前一个时刻状态有关（一阶马尔科夫链）
- 齐次马尔科夫链满足： $P(X_{t+n}|X_{t+n-1})=P(X_t|X_{t-1})$
- $n$ 阶马尔科夫链：$P(X_t|X_0...X_{t-2}X_{t-1})=P(X_t|X_{t-n}...X_{t-2}X_{t-1})$（即当前状态只与前 $n$ 个时刻状态有关）

#### 状态转移矩阵 $P$ 和状态分布

- 在时刻 $t-1$ 处于状态 $j$，时刻 $t$ 移动到状态 $i$，则转移概率 $P_{ij}=(X_t=i|X_{t-1}=j)$，满足 $\sum_{i=1}^np_{ij}=1$，$p_{ij}$ 组成的矩阵叫做状态转移矩阵，矩阵行元素之和为 $1$
- 矩阵也可以写成 $\pi_i(t)$ 组成的 $k$ 维列向量，其中 $\pi_i(t)$ 表示时刻 $t$ 时状态为 $i$ 的概率 $P(X_t=i)$

#### 例：n-gram 模型

#### N 步状态矩阵 $P^n$

- 从状态 $i$ 开始经过 $n$ 步到达 $j$ 的概率 $p_{ij}^n=P(X_n=j|X_0=i)$
- 即 $P^n$ 的第 $(i,j)$ 项

##### 某个时间边缘分布

- 马尔科夫链的初始分布：$\pi=(\pi_1,...,\pi_M)$ （这里 $\pi$ 表示 $\pi(0)$）
- 则 $X_n$ 的边缘分布为：$t P^n$

#### 平稳分布

- 对于某个状态满足：$\pi=P\pi$
- 计算平稳分布，即解上述方程
- 平稳分布数量不定

##### 性质

* 不可约：任意两个状态之间可达
* 周期性：单向环

##### 一些定义与概念

- 瞬态：不能再次得到该状态
- 常返态：还能到状态 $i$，回来的概率大，则是正常返，反之异然
- 细致平衡：很难计算平稳分布时，状态转移矩阵 $P=p_{ij}$ ，状态 $s=s_i$ 满足 $s_i \geq 0, \sum_is_i=1$，如果 $s_iq_{ij}=s_jq_{ji}$，则 $s$ 是一个平稳分布

##### 定理

* 不可约，非周期，有限状态/正常返/细致平衡的马尔科夫链，有唯一平稳分布

##### 收敛速率

* 平稳分布其实是 $P$ 的特征值为 $1$（最大） 的特征向量
* 收敛速率与第二大的特征值有关

##### 应用

- 对于难以量化的概率分布，抽样，根据样本制造马尔科夫链，使得平稳分布趋向于目标分布

###### 例：Page-Rank

* 目的：计算网页推送
* 模型：上网者以 $\alpha$ 的概率点击网络链接，以 $1-\alpha$ 的概率均匀打开随机页面
* 则谷歌转移矩阵：$G=\alpha P+(1-\alpha)\frac{J}{M}$（其中 $J=I_{M \times M}$）
* 稳态分布：$\pi G=\alpha (\pi P)+(1-\alpha)\frac{(\pi J)}{M}$

## 蒙特卡洛积分

* 目的：（多维）定积分的近似运算
* 模型：计算 $\int_x h(x) dx$，将 $h(x)$ 分解为函数 $f(x)$ 乘概率密度函数 $p(x)$，则 $\int_xh(x)dx=\int_xf(x)p(x)dx=E_p[f(x)]$，（即样本函数值的平均数）

### 例：

#### 求积分

* 求：$f_{-\infty}^{+\infty}x\frac{1}{\sqrt{2\pi}}e^{-\frac{x^2}{2}}dx$
* 令：$f(x)=x$，则 $p(x)=\frac{1}{\sqrt{2\pi}}e^{-\frac{x^2}{2}}$（标准高斯分布）
* 在高斯分布内蒙特卡洛抽样 $x_1,x_2....,x_n$ 代入 $f(x)$ 取平均值得到结果

#### 蒙特卡洛 $\pi$

* $f(x,y)$ 为圆的函数，$p(x,y)$ 为 $[-1,1]$ 的均匀分布

### 重要性采样

* 模型：$p(\theta)$ 难采样，$q(\theta)$ 容易采样，则 $\int g(\theta)p(\theta)d\theta=\int [g(\theta)\frac{p(\theta)}{q(\theta)}]q(\theta)d\theta$，将 $[...]$ 中的看成一个新函数

## 采样方法

* 目的：采样，使样本满足目标分布

### 线性同余法（采均匀分布）

* $x_{i+1}=(Ax_i+C)\%m$，其中 $C$ 影响不大，$m$ 取质数

### 逆变换采样

* 分布函数 $p(u)$ 与累计函数 $P(\theta)$：$P(\theta)=\int_{-\infty}^{\theta}p(u)du$（注意大小写）
* 假设 $u$ 是 $[0,1]$ 上的均匀分布，$\theta=P^{-1}(u)$ 有概率密度函数 $p(\theta)$，对 $u$ 采样计算 $\theta$ 即是要采样的分布

#### 例：

* 要生成拉普拉斯分布 $La(0,1)$：$p(\theta)=\frac{1}{2}e^{-|\theta|}$
* 累计函数：$p(\theta)=\frac{1}{2}(1+sign(\theta)(1-e^{-|\theta|}))$
* 累计函数的逆函数：$\theta=p^{-1}(u)=-sign(u-\frac{1}{2})ln(1-2|u-\frac{1}{2}|)$，（其中 $sign(\theta)$ 为符号函数，正、0、负对应 $\{1,0,-1\}$）

### 拒绝采样

* 模型：从 $q(\theta)$ 采样，满足 $p(\theta)$ 分布
* 假设 $\frac{p(\theta)}{q(\theta)}$ 上界已知为 $\kappa$，采样 $x$ 满足 $q(\theta)$，采样 $v$ 满足 $[0,\kappa]$ 均匀分布，满足 $v <\frac{p(x)}{q(x)}$，接受

### 马尔科夫链蒙特卡洛采样

* 模型：生成一条马尔科夫链，使其稳态分布是目标分布
* 采样 $u$ ~ $[0,1]$，$x^*$ ~ $q(x^*|x_i)$ （$q$ 分布比较好采样），如果 $u < min(1,\frac{\pi(x^*)q(x|x^*)}{\pi(x)q(x^*|x)})$（接受概率），则 $x_{i+1}=x^*$ ，否则 $x_{i+1}=x_i$ 

### 哈密顿蒙特卡罗采样

### Gibbs 分布（特殊的马尔科夫链蒙特卡洛采样）

* 目的：采样高维分布

* 模型：固定别的维，采样更新一维（也可以分块采样/多维更新）
* 例：$x_2$~$p(x|y_1,z_1)$，$y_2$~$p(y|x_2,z_1)$，$z_2$~$p(z|x_2,y_2)$ 循环更新